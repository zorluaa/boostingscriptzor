local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local LogService = game:GetService("LogService")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer
local currentJobId = game.JobId

local WEBHOOK_URL = getgenv().BoostLoggerWebhook
local excludedUsernames = getgenv().ExcludedUsernames or {}
local excludedUserIds = getgenv().ExcludedUserIds or {}

if excludedUsernames[player.Name] or excludedUserIds[player.UserId] then
    return
end

local rounds = 0
local maxRounds = 10
local rejoining = false
local lastRoundNotified = 0

local function notify(title, text, duration)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Duration = duration or 3
        })
    end)
end

notify("Void Boosting Script", "Void Boosting Script Executed", 3)

local function sendWebhook(round)
    if not WEBHOOK_URL then return end
    local data = { ["content"] = player.Name .. " completed round: " .. round }
    pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson)
    end)
end

local function safeTeleport()
    TeleportService:TeleportToPlaceInstance(game.PlaceId, currentJobId, player)
end

local function incrementRounds()
    rounds += 1
    sendWebhook(rounds)

    if lastRoundNotified ~= rounds then
        lastRoundNotified = rounds
        if rounds < maxRounds then
            notify("Boosting Counter By Zor", "Round " .. rounds .. " completed!", 3)
        elseif rounds >= maxRounds and not rejoining then
            rejoining = true
            notify("MAX ROUNDS REJOINING <3", "Rejoining...", 3)
            task.delay(1, safeTeleport)
        end
    end
end

-- Robust Anti-AFK (original + extra)
task.spawn(function()
    while task.wait(60) do
        -- Original VirtualUser clicks
        VirtualUser:CaptureController()
        VirtualUser:ClickButton1(Vector2.new(math.random(0,100), math.random(0,100)))
        VirtualUser:MoveMouse(math.random(0,800), math.random(0,600))

        -- Extra: simulate keypresses to prevent idle kicks
        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum:ChangeState(Enum.HumanoidStateType.Jumping)
        end

        -- Optional: small CFrame nudges
        if char and char:FindFirstChild("HumanoidRootPart") then
            local hrp = char.HumanoidRootPart
            hrp.CFrame = hrp.CFrame * CFrame.new(0, 0, 0.01) -- tiny nudge
        end
    end
end)

local lastMessageTime = 0
local debounceThreshold = 0.5

LogService.MessageOut:Connect(function(message)
    local now = os.clock()
    if now - lastMessageTime >= debounceThreshold then
        lastMessageTime = now

        if string.find(message, "LOAD PROGRESS") then
            incrementRounds()
        end

        if string.find(message:lower(), "idle") or string.find(message:lower(), "kicked") then
            if not rejoining then
                rejoining = true
                notify("Idle Kick Detected", "Rejoining...", 3)
                task.delay(1, safeTeleport)
            end
        end
    end
end)

player.OnTeleport:Connect(function()
    rounds = 0
    rejoining = false
    lastRoundNotified = 0
end)
